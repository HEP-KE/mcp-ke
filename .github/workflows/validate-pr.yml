name: Validate PR

on:
  pull_request:
    branches: [main]
    paths:
      - 'config.yaml'
      - 'ke_mcp/**'
      - 'automation/**'
      - 'tests/**'
  push:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install core dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml mcp

      - name: Validate config schema
        run: python automation/validate_config.py

      - name: Generate requirements.txt
        run: python automation/generate_requirements.py

      - name: Generate README.md
        run: python automation/update_readme.py

      - name: Check for uncommitted changes
        run: |
          git diff --exit-code requirements.txt README.md || {
            echo "❌ Generated files are out of sync!"
            echo "Run 'pip install -e .' locally to regenerate"
            exit 1
          }

      - name: Install team tools
        run: pip install -r requirements.txt

      - name: Run config tests
        run: python tests/test_config.py

      - name: Run tool validation tests
        run: python tests/test_tools.py

      - name: Test server startup
        run: |
          timeout 5s python ke_mcp/src/server.py || {
            if [ $? -eq 124 ]; then
              echo "✓ Server started successfully (timeout expected)"
              exit 0
            else
              echo "❌ Server failed to start"
              exit 1
            fi
          }

  pr-comment:
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Generate PR summary
        id: summary
        run: |
          python3 << 'EOF'
          import os
          import yaml
          from pathlib import Path

          config = yaml.safe_load(open("config.yaml"))
          tools = config["tools"]

          summary = f"### Tool Registry Update\n\n"
          summary += f"**Total Tools**: {len(tools)}\n\n"
          summary += "| Tool | Repository | Version | Contact |\n"
          summary += "|------|------------|---------|----------|\n"

          for tool_id, cfg in tools.items():
              summary += f"| {tool_id} | {cfg['repository']} | {cfg['version']} | {cfg['contact']} |\n"

          # Write to GitHub output
          with open(Path(os.environ['GITHUB_OUTPUT']), 'a') as f:
              f.write(f"summary<<EOF\n{summary}\nEOF\n")
          EOF

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: process.env.SUMMARY
            })
        env:
          SUMMARY: ${{ steps.summary.outputs.summary }}
